<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>CEO Visibility Dashboard (Live)</title>

    <!-- Cache-bust & defaults -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com?v=2025-10-10-4"></script>
    <!-- React 18 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <!-- Babel (JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" data-presets="env,react"></script>

    <!-- Firebase (Compat for brevity) -->
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>
  </head>
  <body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useRef } = React;

      /* ======== FIREBASE INIT ======== */
      const firebaseConfig = {
        apiKey: "AIzaSyAyt3CXWIKQ_bjQN48cw-GSXKKP5FbCoWs",
        authDomain: "ceo-visibility-tool-75651.firebaseapp.com",
        projectId: "ceo-visibility-tool-75651",
        storageBucket: "ceo-visibility-tool-75651.appspot.com",
        messagingSenderId: "451190943437",
        appId: "1:451190943437:web:9ee1a3891a79445aa3c384"
      };
      if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const docRef = db.collection("ceo-dashboard").doc("state");

      const clientId = (crypto?.randomUUID?.() || Math.random().toString(36).slice(2));
      const today = () => new Date().toISOString().split("T")[0];

      const StatusPill = ({ status }) => {
        const map = {
          green: { cls: "text-green-600 bg-green-100", emoji: "üü¢" },
          yellow:{ cls: "text-yellow-600 bg-yellow-100", emoji: "üü°" },
          red:   { cls: "text-red-600 bg-red-100", emoji: "üî¥" }
        };
        const s = map[status] || { cls: "text-gray-600 bg-gray-100", emoji: "‚è±Ô∏è" };
        return (
          <span className={`px-2 py-1 rounded-full flex items-center gap-1 text-sm font-medium ${s.cls}`}>
            <span>{s.emoji}</span><span className="capitalize">{status || 'unknown'}</span>
          </span>
        );
      };

      function CEODashboard() {
        const initialDepartments = [
          { id:'ops', name:'Operations', manager:'Jagan', status:'green',
            keyMetrics:{ efficiency:0, tasksCompleted:0, onTimeDelivery:0, qualityScore:0 },
            projects:[], blockers:[], weeklyUpdate:{ wins:'',challenges:'',nextWeek:'',date:today() } },
          { id:'clinical', name:'Clinical Operations', manager:'Betty', status:'green',
            keyMetrics:{ patientSatisfaction:0, clinicalAccuracy:0, processCompliance:0, turnaroundTime:0 },
            projects:[], blockers:[], weeklyUpdate:{ wins:'',challenges:'',nextWeek:'',date:today() } },
          { id:'pharmacy', name:'Pharmacy', manager:'Dr. Jallow', status:'green',
            keyMetrics:{ rxAccuracy:0, avgDispenseTime:0, inventoryAccuracy:0, counselingRate:0 },
            projects:[], blockers:[], weeklyUpdate:{ wins:'',challenges:'',nextWeek:'',date:today() } },
          { id:'marketing', name:'Social Media & Marketing', manager:'Awa', status:'green',
            keyMetrics:{ campaignReach:0, leadGen:0, conversionRate:0, publishingCadence:0 },
            projects:[], blockers:[], weeklyUpdate:{ wins:'',challenges:'',nextWeek:'',date:today() } },
          { id:'globalfund', name:'Global Fund', manager:'Nafi', status:'green',
            keyMetrics:{ fundingSecured:0, proposalsSubmitted:0, complianceScore:0, reportingTimeliness:0 },
            projects:[], blockers:[], weeklyUpdate:{ wins:'',challenges:'',nextWeek:'',date:today() } },
          { id:'retail', name:'Retail', manager:'Mabinta', status:'green',
            keyMetrics:{ salesGrowth:0, inventoryTurnover:0, customerSatisfaction:0, storePerformance:0 },
            projects:[], blockers:[], weeklyUpdate:{ wins:'',challenges:'',nextWeek:'',date:today() } },
          { id:'subscription', name:'Subscription', manager:'Lena', status:'green',
            keyMetrics:{ monthlyRecurringRevenue:0, churnRate:0, customerAcquisition:0, retentionRate:0 },
            projects:[], blockers:[], weeklyUpdate:{ wins:'',challenges:'',nextWeek:'',date:today() } },
          { id:'finance', name:'Finance', manager:'Yusupha', status:'green',
            keyMetrics:{ budgetVariance:0, cashFlow:0, accountsReceivable:0, costReduction:0 },
            projects:[], blockers:[], weeklyUpdate:{ wins:'',challenges:'',nextWeek:'',date:today() } },
          { id:'hr', name:'Human Resources', manager:'Mariam', status:'green',
            keyMetrics:{ retentionRate:0, timeToHire:0, trainingCompletion:0, engagementScore:0 },
            projects:[], blockers:[], weeklyUpdate:{ wins:'',challenges:'',nextWeek:'',date:today() } },
          { id:'srops', name:'Senior Operations', manager:'Vic', status:'green',
            keyMetrics:{ strategicGoals:0, crossTeamCollaboration:0, processOptimization:0, leadershipScore:0 },
            projects:[], blockers:[], weeklyUpdate:{ wins:'',challenges:'',nextWeek:'',date:today() } },
          { id:'technology', name:'Technology', manager:'Kendesoft', status:'green',
            keyMetrics:{ systemUptime:0, bugResolution:0, projectDelivery:0, innovationIndex:0 },
            projects:[], blockers:[], weeklyUpdate:{ wins:'',challenges:'',nextWeek:'',date:today() } },
          { id:'logistics', name:'Logistics', manager:'Modou', status:'green',
            keyMetrics:{ deliveryAccuracy:0, warehouseEfficiency:0, transportCost:0, orderFulfillment:0 },
            projects:[], blockers:[], weeklyUpdate:{ wins:'',challenges:'',nextWeek:'',date:today() } },
        ];

        const cached = (() => {
          try { return JSON.parse(localStorage.getItem("ceoDashboardCache") || "null"); } catch { return null; }
        })();

        // ‚úÖ FIXED: Single declarations only
        const [departments, setDepartments] = useState(cached?.departments || initialDepartments);
        const [history, setHistory] = useState(cached?.history || []);
        const [synced, setSynced] = useState(false);
        const [viewMode, setViewMode] = useState('overview');
        const [selectedDeptId, setSelectedDeptId] = useState(null);
        const [editMode, setEditMode] = useState(false);
        const [newProject, setNewProject] = useState({ name:'', deadline:'', status:'green', completion:0, comments:'' });
        const [showModal, setShowModal] = useState(false);
        const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0,7));
        const [lastSaved, setLastSaved] = useState(cached?.lastSavedAt || '');
        const savingRef = useRef(false);
        const debounceRef = useRef(null);

        // ‚úÖ FIXED: Real-time listener (clean version)
        useEffect(() => {
          const unsub = docRef.onSnapshot(async (snap) => {
            if (!snap.exists) {
              await docRef.set({
                departments: initialDepartments,
                updateHistory: [],
                lastSavedAt: new Date().toISOString(),
                _lastWriter: clientId
              });
              setSynced(true);
              return;
            }
            const data = snap.data();
            
            // Always update from Firestore
            setDepartments(data.departments || initialDepartments);
            setHistory(data.updateHistory || []);
            setLastSaved(new Date(data.lastSavedAt || Date.now()).toLocaleString());
            setSynced(true);
            
            // Update cache
            localStorage.setItem("ceoDashboardCache", JSON.stringify({
              departments: data.departments || initialDepartments,
              history: data.updateHistory || [],
              lastSavedAt: data.lastSavedAt || new Date().toISOString()
            }));
          });
          return () => unsub();
        }, []);

        // ‚úÖ FIXED: Autosave (clean version)
        useEffect(() => {
          if (!synced) return; // Wait for initial sync
          
          localStorage.setItem("ceoDashboardCache", JSON.stringify({
            departments, history, lastSavedAt: new Date().toISOString()
          }));
          
          if (debounceRef.current) clearTimeout(debounceRef.current);
          debounceRef.current = setTimeout(async () => {
            savingRef.current = true;
            const lastSavedAt = new Date().toISOString();
            await docRef.set({ 
              departments, 
              updateHistory: history, 
              lastSavedAt, 
              _lastWriter: clientId 
            }, { merge: true });
            setLastSaved(new Date(lastSavedAt).toLocaleString());
            savingRef.current = false;
          }, 700);
        }, [departments, history, synced]);

        // Mutators
        const updateDeptStatus = (id, status) => {
          setDepartments(prev => prev.map(d => d.id===id ? { ...d, status } : d));
        };
        const updateMetric = (id, key, value) => {
          const num = Number.isNaN(parseFloat(value)) ? 0 : parseFloat(value);
          setDepartments(prev => prev.map(d => d.id===id ? { ...d, keyMetrics: { ...d.keyMetrics, [key]: num } } : d));
        };
        const updateWeekly = (id, field, value) => {
          setDepartments(prev => prev.map(d => d.id===id ? {
            ...d, weeklyUpdate: { ...d.weeklyUpdate, [field]: value, date: today() }
          } : d));
          setHistory(h => [...h, { deptId:id, date:new Date().toISOString(), type:'weekly_update', field, value }]);
        };
        const addProject = (deptId) => {
          if (!newProject.name.trim()) return;
          setDepartments(prev => prev.map(d => d.id===deptId ? {
            ...d,
            projects: [...d.projects, { ...newProject, id: Date.now() }]
          } : d));
          setNewProject({ name:'', deadline:'', status:'green', completion:0, comments:'' });
          setShowModal(false);
        };
        const updateProject = (deptId, projectId, field, value) => {
          setDepartments(prev => prev.map(d => d.id===deptId ? {
            ...d, projects: d.projects.map(p => p.id===projectId
              ? { ...p,
                  [field]:
                    field==='completion'
                      ? Math.min(100, Math.max(0, parseInt(value ?? 0, 10)))
                      : value
                }
              : p)
          } : d));
        };
        const deleteProject = (deptId, projectId) => {
          setDepartments(prev => prev.map(d => d.id===deptId ? {
            ...d, projects: d.projects.filter(p => p.id!==projectId)
          } : d));
        };
        const addBlocker = (deptId, text) => {
          if (!text.trim()) return;
          setDepartments(prev => prev.map(d => d.id===deptId ? {
            ...d, blockers: [...d.blockers, { id: Date.now(), text, date: new Date().toISOString() }]
          } : d));
        };
        const removeBlocker = (deptId, blockerId) => {
          setDepartments(prev => prev.map(d => d.id===deptId ? {
            ...d, blockers: d.blockers.filter(b => b.id !== blockerId)
          } : d));
        };

        const monthlySnapshot = () => {
          const monthData = history.filter(h => h.date?.startsWith?.(selectedMonth));
          return departments.map(d => {
            const deptUpdates = monthData.filter(u => u.deptId === d.id);
            const total = d.projects.length;
            const completed = d.projects.filter(p => (p.completion||0) === 100).length;
            const avg = total>0 ? Math.round(d.projects.reduce((s,p)=>s+(p.completion||0),0)/total) : 0;
            return { ...d, monthlyStats:{ updates:deptUpdates.length, projectsTotal:total, projectsCompleted:completed, avgCompletion:avg, blockerCount:d.blockers.length } };
          });
        };

        const onTrack = departments.filter(d=>d.status==='green').length;
        const atRisk  = departments.filter(d=>d.status==='yellow').length;
        const offTrack= departments.filter(d=>d.status==='red').length;
        const blockers= departments.reduce((s,d)=>s+d.blockers.length,0);
        const projects= departments.reduce((s,d)=>s+d.projects.length,0);

        const liveDept = selectedDeptId ? departments.find(d => d.id === selectedDeptId) : null;

        return (
          <div className="min-h-screen p-4 md:p-6">
            {/* ‚úÖ Loading indicator */}
            {!synced && (
              <div className="fixed inset-0 bg-white/90 flex items-center justify-center z-50">
                <div className="text-center">
                  <div className="text-2xl mb-2">‚è≥</div>
                  <div className="text-lg font-semibold">Syncing with server...</div>
                  <div className="text-sm text-gray-600">Loading latest data</div>
                </div>
              </div>
            )}

            <div className="max-w-7xl mx-auto">
              {/* Header */}
              <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                  <div>
                    <h1 className="text-2xl md:text-3xl font-bold text-gray-900">CEO Visibility Dashboard</h1>
                    <p className="text-gray-600 mt-2">High-level view of priorities, blockers, and momentum (Live Sync)</p>
                  </div>
                  <div className="flex items-center gap-3">
                    <span className="text-xs px-2 py-1 bg-gray-100 rounded text-gray-600">
                      {savingRef.current ? "Saving..." : (lastSaved ? `Saved ${lastSaved}` : "‚Äî")}
                    </span>
                    <button
                      onClick={async () => {
                        if (!confirm("This will clear the SHARED dashboard for everyone. Continue?")) return;
                        await docRef.set({
                          departments: initialDepartments, updateHistory: [],
                          lastSavedAt: new Date().toISOString(), _lastWriter: clientId
                        });
                      }}
                      className="px-3 py-2 rounded-lg text-xs bg-gray-100 hover:bg-gray-200 text-gray-700"
                      title="Reset the shared data for all users"
                    >
                      Reset Shared Data
                    </button>
                  </div>
                </div>

                <div className="flex flex-wrap gap-2 mt-4">
                  {['overview','details','updates','monthly'].map(mode => (
                    <button key={mode}
                      onClick={()=> setViewMode(mode)}
                      className={`px-4 py-2 rounded-lg font-medium transition-colors ${viewMode===mode?'bg-blue-600 text-white':'bg-gray-100 text-gray-700 hover:bg-gray-200'}`}
                      {...(mode==='details' && !liveDept ? {disabled:true, title:'Select a department from Overview first'} : {})}
                    >
                      {mode==='overview' && 'Overview'}
                      {mode==='details'  && 'Details'}
                      {mode==='updates'  && 'Weekly Updates'}
                      {mode==='monthly'  && 'Monthly Snapshot'}
                    </button>
                  ))}
                </div>

                <div className="grid grid-cols-2 md:grid-cols-5 gap-3 mt-6">
                  <CardStat label="On Track" value={onTrack} cls="bg-green-50 text-green-900" valCls="text-green-600"/>
                  <CardStat label="At Risk" value={atRisk} cls="bg-yellow-50 text-yellow-900" valCls="text-yellow-600"/>
                  <CardStat label="Off Track" value={offTrack} cls="bg-red-50 text-red-900" valCls="text-red-600"/>
                  <CardStat label="Blockers" value={blockers} cls="bg-blue-50 text-blue-900" valCls="text-blue-600"/>
                  <CardStat label="Projects" value={projects} cls="bg-purple-50 text-purple-900" valCls="text-purple-600"/>
                </div>
              </div>

              {/* Overview */}
              {viewMode==='overview' && (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {departments.map(dept => (
                    <div key={dept.id} className="bg-white rounded-lg shadow-sm p-5 hover:shadow-md transition-shadow">
                      <div className="flex justify-between items-start mb-4">
                        <div>
                          <h3 className="text-lg font-semibold text-gray-900">{dept.name}</h3>
                          <p className="text-sm text-gray-600">{dept.manager}</p>
                        </div>
                        <StatusPill status={dept.status}/>
                      </div>

                      {dept.projects.length>0 ? (
                        <div className="space-y-2 mb-4">
                          {dept.projects.slice(0,2).map(p=>(
                            <div key={p.id} className="flex items-center justify-between">
                              <span className="text-sm text-gray-700 truncate max-w-[60%]">{p.name}</span>
                              <div className="flex items-center gap-2">
                                <div className="w-16 bg-gray-200 rounded-full h-1.5">
                                  <div className={`h-1.5 rounded-full ${p.status==='green'?'bg-green-500':p.status==='yellow'?'bg-yellow-500':'bg-red-500'}`} style={{width:`${p.completion}%`}}></div>
                                </div>
                                <span className="text-xs text-gray-600">{p.completion}%</span>
                              </div>
                            </div>
                          ))}
                          {dept.projects.length>2 && <p className="text-xs text-gray-500">+{dept.projects.length-2} more projects</p>}
                        </div>
                      ) : <p className="text-sm text-gray-500 mb-4">No active projects</p>}

                      {dept.blockers.length>0 && (
                        <div className="bg-red-50 rounded-lg p-3 mb-3">
                          <div className="flex items-center gap-2 mb-1">
                            <span className="text-red-600">‚ùó</span>
                            <span className="text-sm font-medium text-red-900">
                              {dept.blockers.length} Blocker{dept.blockers.length>1?'s':''}
                            </span>
                          </div>
                          <p className="text-xs text-red-800 truncate">{dept.blockers[0].text}</p>
                        </div>
                      )}

                      <div className="flex items-center justify-between text-xs text-gray-500">
                        <span>Last update: {dept.weeklyUpdate.date}</span>
                        <button
                          onClick={()=>{ setSelectedDeptId(dept.id); setViewMode('details'); }}
                          className="text-blue-600 hover:text-blue-700 font-medium"
                        >View ‚Üí</button>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {/* Details */}
              {viewMode==='details' && liveDept && (
                <DetailsView
                  dept={liveDept}
                  editMode={editMode}
                  setEditMode={setEditMode}
                  updateDeptStatus={updateDeptStatus}
                  updateMetric={updateMetric}
                  updateProject={updateProject}
                  deleteProject={deleteProject}
                  addProject={addProject}
                  newProject={newProject}
                  setNewProject={setNewProject}
                  showModal={showModal}
                  setShowModal={setShowModal}
                  addBlocker={addBlocker}
                  removeBlocker={removeBlocker}
                  goBack={()=> setSelectedDeptId(null)}
                />
              )}

              {/* Weekly updates */}
              {viewMode==='updates' && (
                <div className="space-y-4">
                  {departments.map(d => (
                    <div key={d.id} className="bg-white rounded-lg shadow-sm p-6">
                      <div className="flex justify-between items-start mb-4">
                        <div>
                          <h3 className="text-xl font-semibold text-gray-900">{d.name}</h3>
                          <p className="text-sm text-gray-600">{d.manager} ‚Ä¢ {d.weeklyUpdate.date}</p>
                        </div>
                        <StatusPill status={d.status}/>
                      </div>

                      <div className="space-y-4">
                        <Area title="‚úÖ Wins This Week" value={d.weeklyUpdate.wins}
                          onChange={(v)=> updateWeekly(d.id, 'wins', v)} />
                        <Area title="‚ö†Ô∏è Challenges" value={d.weeklyUpdate.challenges}
                          onChange={(v)=> updateWeekly(d.id, 'challenges', v)} />
                        <Area title="‚û°Ô∏è Next Week Focus" value={d.weeklyUpdate.nextWeek}
                          onChange={(v)=> updateWeekly(d.id, 'nextWeek', v)} />
                        {d.blockers.length>0 && (
                          <div className="bg-red-50 rounded-lg p-3">
                            <h4 className="font-medium text-red-900 mb-2">üö® Active Blockers ({d.blockers.length})</h4>
                            {d.blockers.map(b => <p key={b.id} className="text-sm text-red-800">‚Ä¢ {b.text}</p>)}
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {/* Monthly snapshot */}
              {viewMode==='monthly' && (
                <MonthlyView
                  selectedMonth={selectedMonth}
                  setSelectedMonth={setSelectedMonth}
                  snapshot={monthlySnapshot()}
                  departments={departments}
                />
              )}

              {/* Export */}
              <div className="mt-6 text-center">
                <button
                  onClick={() => {
                    const dataStr = JSON.stringify({departments, history}, null, 2);
                    const uri = 'data:application/json;charset=utf-8,'+encodeURIComponent(dataStr);
                    const name = `ceo-dashboard-${new Date().toISOString().split('T')[0]}.json`;
                    const a = document.createElement('a');
                    a.href = uri; a.download = name;
                    document.body.appendChild(a); a.click(); a.remove();
                  }}
                  className="text-sm text-gray-500 hover:text-gray-700"
                >Export Data (JSON)</button>
              </div>
            </div>
          </div>
        );
      }

      /* --- Small components --- */
      const CardStat = ({label, value, cls, valCls}) => (
        <div className={`${cls} rounded-lg p-3`}>
          <div className="flex items-center justify-between">
            <span className="font-medium text-sm">{label}</span>
            <span className={`text-xl font-bold ${valCls}`}>{value}</span>
          </div>
        </div>
      );

      const Area = ({title, value, onChange}) => (
        <div>
          <h4 className="font-medium mb-1">{title}</h4>
          <textarea rows="2" className="w-full px-3 py-2 border rounded-lg text-gray-700"
            value={value} onChange={(e)=> onChange(e.target.value)} />
        </div>
      );

      function DetailsView(props){
        const { dept, editMode, setEditMode, updateDeptStatus, updateMetric,
                updateProject, deleteProject, addProject, newProject, setNewProject,
                showModal, setShowModal, addBlocker, removeBlocker, goBack } = props;

        return (
          <div className="bg-white rounded-lg shadow-sm p-6">
            <div className="flex justify-between items-start mb-6">
              <div>
                <h2 className="text-2xl font-bold text-gray-900">{dept.name}</h2>
                <p className="text-gray-600">Manager: {dept.manager}</p>
              </div>
              <div className="flex items-center gap-2">
                <button onClick={()=> setEditMode(m=>!m)}
                  className={`px-3 py-1.5 rounded-lg font-medium ${editMode?'bg-green-600 text-white':'bg-gray-100 text-gray-700'}`}>
                  {editMode ? 'Done' : 'Edit'}
                </button>
                <select value={dept.status} onChange={(e)=> updateDeptStatus(dept.id, e.target.value)}
                  className="px-4 py-2 rounded-lg font-medium border-2">
                  <option value="green">üü¢ On Track</option>
                  <option value="yellow">üü° At Risk</option>
                  <option value="red">üî¥ Off Track</option>
                </select>
              </div>
            </div>

            {/* Key Metrics */}
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-gray-900 mb-4">Key Metrics</h3>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                {Object.entries(dept.keyMetrics).map(([k,v])=>(
                  <div key={k} className="bg-gray-50 rounded-lg p-4">
                    <p className="text-sm text-gray-600 capitalize mb-1">{k.replace(/([A-Z])/g,' $1').trim()}</p>
                    {editMode ? (
                      <input type="number" value={v}
                        onChange={(e)=> updateMetric(dept.id, k, e.target.value)}
                        className="w-full px-2 py-1 border rounded"/>
                    ) : (
                      <p className="text-2xl font-bold text-gray-900">{v || 0}</p>
                    )}
                  </div>
                ))}
              </div>
            </div>

            {/* Projects */}
            <div className="mb-6">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-semibold text-gray-900">Projects</h3>
                {editMode && (
                  <button onClick={()=> setShowModal(true)} className="px-3 py-1.5 bg-blue-600 text-white rounded-lg font-medium">
                    + Add Project
                  </button>
                )}
              </div>

              {dept.projects.length>0 ? (
                <div className="space-y-3">
                  {dept.projects.map(p=>(
                    <div key={p.id} className="border rounded-lg p-4">
                      <div className="flex justify-between items-start mb-2">
                        {editMode ? (
                          <input type="text" value={p.name}
                            onChange={(e)=> updateProject(dept.id, p.id, 'name', e.target.value)}
                            className="font-medium text-gray-900 px-2 py-1 border rounded flex-1 mr-2"/>
                        ) : (
                          <h4 className="font-medium text-gray-900">{p.name}</h4>
                        )}
                        <div className="flex items-center gap-2">
                          {editMode ? (
                            <select value={p.status}
                              onChange={(e)=> updateProject(dept.id, p.id, 'status', e.target.value)}
                              className="px-2 py-1 rounded text-xs font-medium border">
                              <option value="green">Green</option>
                              <option value="yellow">Yellow</option>
                              <option value="red">Red</option>
                            </select>
                          ) : (
                            <StatusPill status={p.status}/>
                          )}
                          {editMode && (
                            <button onClick={()=> deleteProject(dept.id, p.id)} className="text-red-600 hover:text-red-700 text-sm">Delete</button>
                          )}
                        </div>
                      </div>

                      <div className="flex items-center gap-4 mb-3">
                        <div className="flex-1">
                          <div className="w-full bg-gray-200 rounded-full h-2">
                            <div className={`${p.status==='green'?'bg-green-500':p.status==='yellow'?'bg-yellow-500':'bg-red-500'} h-2 rounded-full`} style={{width:`${p.completion}%`}}></div>
                          </div>
                        </div>
                        {editMode ? (
                          <input type="number" min="0" max="100" value={p.completion}
                            onChange={(e)=> updateProject(dept.id, p.id, 'completion', e.target.value)}
                            className="w-16 px-2 py-1 border rounded text-sm"/>
                        ) : (
                          <span className="text-sm text-gray-600">{p.completion}%</span>
                        )}
                        <span className="text-sm text-gray-600">Due: {p.deadline || 'TBD'}</span>
                      </div>

                      <div>
                        <label className="text-sm font-medium text-gray-700 block mb-1">Comments / Notes</label>
                        {editMode ? (
                          <textarea
                            className="w-full px-3 py-2 border rounded-lg text-gray-700"
                            rows="2"
                            value={p.comments || ''}
                            onChange={(e)=> updateProject(dept.id, p.id, 'comments', e.target.value)}
                            placeholder="Add context, decisions, risks‚Ä¶"
                          />
                        ) : (
                          <p className="text-sm text-gray-700 whitespace-pre-wrap">
                            {p.comments ? p.comments : <span className="text-gray-400">No comments yet.</span>}
                          </p>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              ) : <p className="text-gray-500">No projects added yet</p>}
            </div>

            {/* Blockers */}
            <div className="mb-6">
              <h3 className="text-lg font-semibold text-gray-900 mb-4">Blockers & Escalations</h3>
              <div className="space-y-2">
                {dept.blockers.map(b => (
                  <div key={b.id} className="flex items-start gap-2 bg-red-50 p-3 rounded-lg">
                    <span className="mt-0.5">üö®</span>
                    <span className="flex-1 text-sm text-red-900">{b.text}</span>
                    <button onClick={()=> removeBlocker(dept.id, b.id)} className="text-red-600 hover:text-red-700 text-sm">Resolve</button>
                  </div>
                ))}
                <div className="flex gap-2">
                  <input type="text" placeholder="Add new blocker..." className="flex-1 px-3 py-2 border rounded-lg"
                    onKeyDown={(e)=> { if(e.key==='Enter'){ addBlocker(dept.id, e.currentTarget.value); e.currentTarget.value=''; }}}/>
                </div>
              </div>
            </div>

            <button onClick={goBack} className="text-blue-600 hover:text-blue-700 font-medium">‚Üê Back to Overview</button>

            {showModal && (
              <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                <div className="bg-white rounded-lg p-6 w-96">
                  <h3 className="text-lg font-semibold mb-4">Add New Project</h3>
                  <input className="w-full px-3 py-2 border rounded-lg mb-3" placeholder="Project name"
                    value={newProject.name} onChange={e=> setNewProject({...newProject, name:e.target.value})}/>
                  <input type="date" className="w-full px-3 py-2 border rounded-lg mb-3"
                    value={newProject.deadline} onChange={e=> setNewProject({...newProject, deadline:e.target.value})}/>
                  <select className="w-full px-3 py-2 border rounded-lg mb-3"
                    value={newProject.status} onChange={e=> setNewProject({...newProject, status:e.target.value})}>
                    <option value="green">üü¢ On Track</option>
                    <option value="yellow">üü° At Risk</option>
                    <option value="red">üî¥ Off Track</option>
                  </select>
                  <input type="number" min="0" max="100" className="w-full px-3 py-2 border rounded-lg mb-3"
                    placeholder="Completion %" value={newProject.completion}
                    onChange={e=> setNewProject({...newProject, completion: Math.min(100, Math.max(0, parseInt(e.target.value||0,10)))})}/>
                  <textarea className="w-full px-3 py-2 border rounded-lg mb-4" rows="2"
                    placeholder="Comments / Notes (optional)"
                    value={newProject.comments}
                    onChange={e=> setNewProject({...newProject, comments: e.target.value})}/>
                  <div className="flex gap-2">
                    <button className="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg font-medium"
                      onClick={()=> addProject(dept.id)}>Add Project</button>
                    <button className="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium"
                      onClick={()=> setShowModal(false)}>Cancel</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      const MonthlyView = ({selectedMonth, setSelectedMonth, snapshot, departments}) => (
        <div className="space-y-6">
          <div className="bg-white rounded-lg shadow-sm p-6">
            <div className="flex justify-between items-center mb-6">
              <h2 className="text-2xl font-bold text-gray-900">Monthly Snapshot</h2>
              <input type="month" value={selectedMonth} onChange={(e)=> setSelectedMonth(e.target.value)}
                className="px-4 py-2 border rounded-lg"/>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {snapshot.map(d => (
                <div key={d.id} className="border rounded-lg p-4">
                  <div className="flex justify-between items-start mb-3">
                    <div>
                      <h3 className="font-semibold text-gray-900">{d.name}</h3>
                      <p className="text-sm text-gray-600">{d.manager}</p>
                    </div>
                    <StatusPill status={d.status}/>
                  </div>

                  <div className="space-y-2">
                    <Row label="Updates Posted" value={d.monthlyStats.updates} />
                    <Row label="Projects" value={`${d.monthlyStats.projectsCompleted}/${d.monthlyStats.projectsTotal}`} />
                    <Row label="Avg Completion" value={`${d.monthlyStats.avgCompletion}%`} />
                    <Row label="Active Blockers" value={d.monthlyStats.blockerCount} />
                  </div>

                  <div className="mt-3 pt-3 border-t">
                    {d.monthlyStats.avgCompletion>70 && d.monthlyStats.blockerCount=== 0 ? (
                      <Badge text="High Performer" tone="green">üèÖ</Badge>
                    ) : d.monthlyStats.updates < 2 ? (
                      <Badge text="Needs More Updates" tone="yellow">‚ö†Ô∏è</Badge>
                    ) : (
                      <Badge text="On Track" tone="blue">üìä</Badge>
                    )}
                  </div>
                </div>
              ))}
            </div>

            <div className="mt-6 pt-6 border-t">
              <h3 className="text-lg font-semibold mb-4">Overall Performance</h3>
              {(() => {
                const totalUpdates   = snapshot.reduce((s,d)=>s+d.monthlyStats.updates,0);
                const totalCompleted = snapshot.reduce((s,d)=>s+d.monthlyStats.projectsCompleted,0);
                const avgCompletion  = Math.round(snapshot.reduce((s,d)=>s+d.monthlyStats.avgCompletion,0)/departments.length || 0);
                const totalBlockers  = snapshot.reduce((s,d)=>s+d.monthlyStats.blockerCount,0);
                return (
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <Card label="Total Updates" value={totalUpdates}/>
                    <Card label="Projects Completed" value={totalCompleted}/>
                    <Card label="Avg Completion Rate" value={`${avgCompletion}%`}/>
                    <Card label="Total Blockers" value={totalBlockers}/>
                  </div>
                );
              })()}
            </div>
          </div>
        </div>
      );

      const Row = ({label, value}) => (
        <div className="flex justify-between items-center">
          <span className="text-sm text-gray-600">{label}</span>
          <span className="font-semibold">{value}</span>
        </div>
      );
      const Card = ({label, value}) => (
        <div className="bg-gray-50 rounded-lg p-4">
          <p className="text-sm text-gray-600">{label}</p>
          <p className="text-2xl font-bold text-gray-900">{value}</p>
        </div>
      );
      const Badge = ({children, text, tone}) => {
        const color = tone==='green'?'text-green-600':tone==='yellow'?'text-yellow-600':'text-blue-600';
        return <div className={`flex items-center gap-1 ${color}`}><span>{children}</span><span className="text-xs font-medium">{text}</span></div>;
      };

      ReactDOM.createRoot(document.getElementById('root')).render(<CEODashboard />);
    </script>
  </body>
</html>
